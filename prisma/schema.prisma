generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Material {
  id            Int      @id @default(autoincrement())
  name          String   @unique
  active        Boolean  @default(true)
  unitPrice     Float    @default(0) @map("unit_price")
  imageKey      String?  @map("image_key")
  articleNumber String?  @map("article_number")

  submissionItems    SubmissionItem[]
  purchaseOrderItems PurchaseOrderItem[]

  @@map("materials")
}

model Submission {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now()) @map("created_at")
  mtTeamRaw     String   @map("mt_team_raw")
  mtTeamNorm    String   @map("mt_team_norm")
  dehpNumber    String   @map("dehp_number")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  address       String   @default("")
  comment       String?
  hasRadiator   Boolean  @default(false) @map("has_radiator")
  photoComplete Boolean  @default(false) @map("photo_complete")

  items       SubmissionItem[]
  attachments Attachment[]

  @@index([mtTeamNorm])
  @@index([dehpNumber])
  @@map("submissions")
}

model SubmissionItem {
  id           Int    @id @default(autoincrement())
  submissionId String @map("submission_id")
  materialId   Int    @map("material_id")
  qty          Int
  unitPrice    Float  @default(0) @map("unit_price")

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  material   Material   @relation(fields: [materialId], references: [id])

  @@map("submission_items")
}

model Attachment {
  id           Int       @id @default(autoincrement())
  submissionId String?   @map("submission_id")
  storageKey   String    @map("storage_key")
  filename     String
  mime         String
  size         Int
  category     String?
  createdAt    DateTime  @default(now()) @map("created_at")

  submission Submission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

model Notification {
  id               Int       @id @default(autoincrement())
  type             String    @default("DEHP_DUPLICATE")
  dehpNumber       String    @map("dehp_number")
  firstTriggeredAt DateTime  @default(now()) @map("first_triggered_at")
  lastSeenCount    Int       @default(2) @map("last_seen_count")
  isClosed         Boolean   @default(false) @map("is_closed")
  closedAt         DateTime? @map("closed_at")

  @@unique([type, dehpNumber])
  @@map("notifications")
}

model AdminUser {
  id           Int    @id @default(autoincrement())
  username     String @unique
  passwordHash String @map("password_hash")

  @@map("admin_users")
}

model PurchaseOrder {
  id          String   @id @default(uuid())
  orderNumber Int      @unique @map("order_number")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  mtTeamRaw   String   @map("mt_team_raw")
  mtTeamNorm  String   @map("mt_team_norm")
  workerName  String   @map("worker_name")
  comment     String?
  priority    String   @default("NORMAL")
  status      String   @default("NEW")
  supplier    String?
  statusNote  String?  @map("status_note")

  items PurchaseOrderItem[]

  @@index([mtTeamNorm])
  @@index([status])
  @@map("purchase_orders")
}

model TeamSettings {
  id            Int    @id @default(autoincrement())
  mtTeamNorm    String @unique @map("mt_team_norm")
  branchAddress String @default("") @map("branch_address")

  @@map("team_settings")
}

model PurchaseOrderItem {
  id              Int    @id @default(autoincrement())
  purchaseOrderId String @map("purchase_order_id")
  materialId      Int    @map("material_id")
  qty             Int
  unitPrice       Float  @default(0) @map("unit_price")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  material      Material      @relation(fields: [materialId], references: [id])

  @@map("purchase_order_items")
}
